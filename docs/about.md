## О расширении

Расширение «SNP Listing Parser» (MV3) собирает данные о недвижимости со страниц объявлений и помогает быстро создать проект на бэкенде SNP.

### Архитектура

- **manifest.json**: настройки MV3, permissions, content_scripts, background service worker, popup.
- **background** (`src/background.ts`): контекстное меню, бейдж статуса, приём сообщений и кэш последнего листинга в `chrome.storage`.
- **content script** (`src/content-script.ts`): автопарсинг страницы, отправка результата, мост SSO токена.
- **popup** (`src/popup/*`): UI статусов/прогресса, редактирование полей, настройки (только SSO), отправка на бэкенд.
- **config** (`src/config.ts`): константы окружения для сборки расширения (например, `API_BASE`, `EXTENSION_AUTH_PATH`).
- **parsers** (`src/parsers/*`): универсальный и доменные парсеры, реестр доменов.
- **utils** (`src/utils/*`): JSON-LD, мета‑теги, нормализация чисел/валют/площадей.

### Авторизация (SSO)

- В popup нажмите «Войти» — откроется страница авторизации по адресу из `API_BASE + EXTENSION_AUTH_PATH` (по умолчанию `https://spacenplace.me/ext/extension-auth`).
- Сайт (если пользователь уже авторизован) публикует токен через `window.postMessage` с типом `SNP_TOKEN`.
- **content script** на домене spacenplace.me перехватывает `postMessage`, сохраняет токен в `chrome.storage` и уведомляет расширение.
- Дальше все запросы к вашему API выполняются с заголовком `Authorization: Bearer <token>`.

### Парсинг данных

- **Универсальный парсер** (`src/parsers/generic.ts`):
  - Читает JSON‑LD (`<script type="application/ld+json">`)
  - Извлекает Open Graph и Twitter мета‑теги
  - Пытается найти цену/валюту, площадь, адрес, заголовок, описание, фото, тип сделки
  - Делает грубую оценку цены за м²
  - Нормализует площадь в м² и валюту (эвристики)
- **Доменные парсеры** (`src/parsers/sites/*`): точечные адаптеры (например, zillow) + большой список доменов, которые по умолчанию обрабатываются generic‑парсером.
- **Реестр** (`src/parsers/registry.ts`): сначала пытается доменный парсер, затем fallback на generic.

### Логика popup (коротко)

- Показывает **статусы полей** (найдено/не найдено), **прогресс** в %.
- Позволяет **дозаполнить** недостающие поля (заголовок, цена/валюта, площадь, адрес, тип сделки, URL картинки).
- Кнопка «Отправить проект» делает `POST /api/projects` на ваш бэкенд:
  - Тело запроса: `{ title, area, imageUrl, address, goal }`
  - Заголовок: `Authorization: Bearer <token>`

### Сборка и установка

- В корне `snp-chrome-ext`:
  - Установка: `pnpm i`
  - При необходимости измените `API_BASE` в `src/config.ts`
  - Сборка: `pnpm build`
  - Загрузить папку `dist` в `chrome://extensions` (режим разработчика).

### Разрешения и безопасность

- `host_permissions`: `<all_urls>` для парсинга, а также домены `spacenplace.me`/`localhost` для SSO.
- Токен хранится в `chrome.storage.local` и используется только для запросов к вашему API.

### Расширение функциональности

- Углубление доменных парсеров (лучшее извлечение адреса, комнат, этажей и т.д.).
- Экспорт дополнительных полей в API (по мере готовности эндпоинтов).
- Улучшение эвристик определения валюты, площади, типа сделки, координат и удобств.
